name: Build Atinout release for Debian arm64

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build-arm64-debian:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-aarch64-linux-gnu dpkg-dev fakeroot ronn

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Patch Makefile
        run: sed -i 's/-Werror//' Makefile

      - name: Build atinout binary
        run: make CC=aarch64-linux-gnu-gcc

      - name: Prepare deb package directory
        run: |
          mkdir -p package/DEBIAN
          mkdir -p package/usr/bin
          cp atinout package/usr/bin/

      - name: Create deb control file
        run: |
          cat > package/DEBIAN/control <<EOF
          Package: atinout
          Version: ${{ steps.version.outputs.version }}
          Section: utils
          Priority: optional
          Architecture: arm64
          Maintainer: Commander-Z3R0
          Description: AT command line utility for serial modems
          EOF

      - name: Build deb package
        run: dpkg-deb --build package

      - name: Rename package
        run: |
          mv package.deb atinout_${{ steps.version.outputs.version }}_arm64.deb

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: atinout_${{ steps.version.outputs.version }}_arm64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
